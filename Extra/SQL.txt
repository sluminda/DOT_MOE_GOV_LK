CREATE TABLE password_resets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    token VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
 

CREATE TABLE userlogin (
    userID INT AUTO_INCREMENT PRIMARY KEY,
    userName VARCHAR(255) UNIQUE,
    userPassword VARCHAR(255) NOT NULL,
    userType ENUM('Admin', 'Super Admin') NOT NULL,
    userEmail VARCHAR(255) UNIQUE NOT NULL,
    userPhoneNumber VARCHAR(10) NOT NULL
)ENGINE=InnoDB DEFAULT CHARSET=latin1;


CREATE TABLE login_records (
    logID INT AUTO_INCREMENT PRIMARY KEY,
    userID INT NOT NULL,
    loginTime DATETIME NOT NULL,
    ipAddress VARCHAR(45) NOT NULL,
    FOREIGN KEY (userID) REFERENCES userlogin(userID)
);



CREATE TABLE data_officers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fullName VARCHAR(200) NOT NULL,
    nameWithInitials VARCHAR(200) NOT NULL,
    nic VARCHAR(12) NOT NULL,
    schoolName VARCHAR(200) NOT NULL,
    schoolSensusNo VARCHAR(7) NOT NULL,
    district VARCHAR(50) NOT NULL,
    province VARCHAR(50) NOT NULL,
    zone VARCHAR(50) NOT NULL,
    contactNo VARCHAR(10) NOT NULL
);




-- Create the institutes table
CREATE TABLE institutes (
    cencode VARCHAR(10) PRIMARY KEY,
    institutionname VARCHAR(255) NOT NULL,
    schooltype INT NOT NULL
);

-- Create the otp_verification table
CREATE TABLE otp_verification (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    otp_hash VARCHAR(64) NOT NULL,
    salt VARCHAR(64) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)ENGINE=InnoDB DEFAULT CHARSET=latin1;



CREATE TABLE data_officer_registration (
    fullName VARCHAR(255) NOT NULL,
    initials VARCHAR(255) NOT NULL,
    nic VARCHAR(20) NOT NULL,
    email VARCHAR(255) NOT NULL,
    whatsapp VARCHAR(20) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    workplace VARCHAR(50) NOT NULL,
    schoolName VARCHAR(255),
    principleName VARCHAR(255),
    principleContactNo VARCHAR(20),
    provinceName VARCHAR(255),
    headOfInstituteName VARCHAR(255),
    headOfInstituteContactNo VARCHAR(20),
    zone VARCHAR(255),
    division VARCHAR(255),
    ip_address VARCHAR(45) NOT NULL,
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (email, nic)
)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE data_officer_registration_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fullName VARCHAR(255) NOT NULL,
    initials VARCHAR(255) NOT NULL,
    nic VARCHAR(20) NOT NULL,
    email VARCHAR(255) NOT NULL,
    whatsapp VARCHAR(20) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    workplace VARCHAR(50) NOT NULL,
    schoolName VARCHAR(255),
    principleName VARCHAR(255),
    principleContactNo VARCHAR(20),
    provinceName VARCHAR(255),
    headOfInstituteName VARCHAR(255),
    headOfInstituteContactNo VARCHAR(20),
    zone VARCHAR(255),
    division VARCHAR(255),
    ip_address VARCHAR(45) NOT NULL,
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)ENGINE=InnoDB DEFAULT CHARSET=latin1;



===============================


CREATE DATABASE IF NOT EXISTS dot_moe_gov_lk;
USE dot_moe_gov_lk;

-- Users table to store user details
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(255) NOT NULL,
    name_with_initials VARCHAR(255) NOT NULL,
    nic VARCHAR(12) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    whatsapp_number VARCHAR(10) NOT NULL,
    mobile_number VARCHAR(10) NOT NULL,
    current_working_place ENUM('School', 'Provincial Office', 'Zonal Office', 'Divisional Office') NOT NULL,
    principle_name VARCHAR(255),
    principle_contact_no VARCHAR(10),
    head_name VARCHAR(255),
    head_contact_no VARCHAR(10),
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- OTPs table to store OTPs
CREATE TABLE IF NOT EXISTS otps (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(200) NOT NULL,
    otp_hash VARCHAR(200) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)ENGINE=InnoDB DEFAULT CHARSET=latin1;


-----------------------------------------------
== This is for the Data Officer Registration Form ==



CREATE TABLE otp_requests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(250) NOT NULL,
    otp_hash VARCHAR(250) NOT NULL,
    expires_at INT NOT NULL
);

===============================

For Data Officer Registration

===============================

-- Creating the workplace_details table
CREATE TABLE workplace_details (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fullName VARCHAR(250) NOT NULL,
    nameWithInitials VARCHAR(250) NOT NULL,
    nic VARCHAR(12) NOT NULL,
    email VARCHAR(250) NOT NULL,
    whatsappNumber VARCHAR(10) NOT NULL,
    mobileNumber VARCHAR(10) NOT NULL,
    headOfInstituteName VARCHAR(250) NOT NULL,
    headOfInstituteContactNo VARCHAR(10) NOT NULL,
    currentWorkingPlace VARCHAR(50) NOT NULL,
    selectedInstituteName VARCHAR(200) NOT NULL,
    Province VARCHAR(50) DEFAULT '',
    District VARCHAR(50) DEFAULT '',
    Zone VARCHAR(50) DEFAULT '',
    Division VARCHAR(50) DEFAULT '',
    submittedAt DATETIME NOT NULL,
    UNIQUE (nic, email)
)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE workplace_details_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fullName VARCHAR(250) NOT NULL,
    nameWithInitials VARCHAR(250) NOT NULL,
    nic VARCHAR(12) NOT NULL,
    email VARCHAR(250) NOT NULL,
    whatsappNumber VARCHAR(10) NOT NULL,
    mobileNumber VARCHAR(10) NOT NULL,
    headOfInstituteName VARCHAR(250) NOT NULL,
    headOfInstituteContactNo VARCHAR(10) NOT NULL,
    currentWorkingPlace VARCHAR(50) NOT NULL,
    selectedInstituteName VARCHAR(200) NOT NULL,
    Province VARCHAR(50) DEFAULT '',
    District VARCHAR(50) DEFAULT '',
    Zone VARCHAR(50) DEFAULT '',
    Division VARCHAR(50) DEFAULT '',
    submittedAt DATETIME NOT NULL
)ENGINE=InnoDB DEFAULT CHARSET=latin1;


-----------------------------------------------

Stored Procedure for save Provincial, Zonal, Divisional Code in to table.

DELIMITER //

CREATE PROCEDURE update_workplace_details(
    IN p_id INT,
    IN p_fullName VARCHAR(250),
    IN p_nameWithInitials VARCHAR(250),
    IN p_nic VARCHAR(12),
    IN p_email VARCHAR(250),
    IN p_whatsappNumber VARCHAR(10),
    IN p_mobileNumber VARCHAR(10),
    IN p_headOfInstituteName VARCHAR(250),
    IN p_headOfInstituteContactNo VARCHAR(10),
    IN p_currentWorkingPlace VARCHAR(50),
    IN p_selectedInstituteName VARCHAR(200),
    IN p_submittedAt DATETIME
)
BEGIN
    DECLARE institute_divcode VARCHAR(6);
    DECLARE institute_zonecode VARCHAR(6);
    DECLARE institute_distcode VARCHAR(3);
    DECLARE filteredSchoolType INT;

    IF p_currentWorkingPlace IN ('provincialOffice', 'zonalOffice', 'divisionalOffice') THEN
        SET filteredSchoolType = 8;
    ELSEIF p_currentWorkingPlace = 'school' THEN
        SET filteredSchoolType = 1 OR 3;
    END IF;

    SELECT divcode, zonecode, distcode INTO institute_divcode, institute_zonecode, institute_distcode
    FROM institutes
    WHERE institutionname = p_selectedInstituteName AND schooltype = filteredSchoolType
    LIMIT 1;

    UPDATE workplace_details
    SET Division = institute_divcode,
        Zone = institute_zonecode,
        District = institute_distcode
    WHERE id = p_id;

    INSERT INTO workplace_details_history
    (fullName, nameWithInitials, nic, email, whatsappNumber, mobileNumber, headOfInstituteName, headOfInstituteContactNo, currentWorkingPlace, selectedInstituteName, submittedAt, Province, District, Zone, Division)
    VALUES
    (p_fullName, p_nameWithInitials, p_nic, p_email, p_whatsappNumber, p_mobileNumber, p_headOfInstituteName, p_headOfInstituteContactNo, p_currentWorkingPlace, p_selectedInstituteName, p_submittedAt, NULL, institute_distcode, institute_zonecode, institute_divcode);
END;
//

DELIMITER ;




===================================================


Institute Table New

DROP TABLE IF EXISTS `institutes`;
CREATE TABLE IF NOT EXISTS `institutes` (
  `old_cencode` varchar(8) NOT NULL,
  `new_cencode` varchar(8) NOT NULL,
  `old_institutionname` varchar(100) DEFAULT '',
  `new_institutionname` varchar(100) DEFAULT '',
  `address` varchar(100) NOT NULL DEFAULT '',
  `distcode` varchar(3) DEFAULT '',
  `zonecode` varchar(6) DEFAULT '',
  `divcode` varchar(6) DEFAULT '',
  `schooltype` int DEFAULT '0',
  `schoolcategory` varchar(1) NOT NULL DEFAULT '',
  `status` int DEFAULT '0',
  PRIMARY KEY (`old_cencode`),
  KEY `cencode` (`old_cencode`),
  KEY `distcode` (`distcode`),
  KEY `zonecode` (`zonecode`),
  KEY `divcode` (`divcode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3;


=======================================
New Institute Table Latest

CREATE TABLE Institutions (
    InstType VARCHAR(10),
    CenCode VARCHAR(10),
    new_cencode VARCHAR(10),
    InstitutionName VARCHAR(150),
    new_InstitutionName VARCHAR(150),
    DistrictCode VARCHAR(10),
    ZoneCode VARCHAR(10),
    DivisionCode VARCHAR(10),
    IsNationalSchool BOOLEAN,
    SchoolType VARCHAR(50),
	SchoolStatus ENUM('Y', 'N')
);






-- Generate 50 dummy values
INSERT INTO `workplace_details_history` (
    `fullName`,
    `nameWithInitials`,
    `nic`,
    `email`,
    `whatsappNumber`,
    `mobileNumber`,
    `headOfInstituteName`,
    `headOfInstituteContactNo`,
    `currentWorkingPlace`,
    `selectedInstituteCode`,
    `selectedInstituteName`,
    `Province`,
    `District`,
    `Zone`,
    `Division`,
    `submittedAt`
)
SELECT
    CONCAT('Full Name ', numbers.n),
    CONCAT('Name Initials ', numbers.n),
    CONCAT('NIC-', LPAD(FLOOR(RAND() * 99999999), 8, '0')),
    CONCAT('email', numbers.n, '@example.com'),
    LPAD(FLOOR(RAND() * 9999999999), 10, '0'),
    LPAD(FLOOR(RAND() * 9999999999), 10, '0'),
    CONCAT('Institute Head ', numbers.n),
    LPAD(FLOOR(RAND() * 9999999999), 10, '0'),
    CONCAT('Workplace ', numbers.n),
    LPAD(FLOOR(RAND() * 99999999), 8, '0'),
    CONCAT('Institute Name ', numbers.n),
    'Province',
    'District',
    'Zone',
    'Division',
    NOW() - INTERVAL FLOOR(RAND() * 30) DAY -- Random submission date within the last month
FROM (
    SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL
    SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL
    SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL
    SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL
    SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20 UNION ALL
    SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL
    SELECT 25 UNION ALL SELECT 26 UNION ALL SELECT 27 UNION ALL SELECT 28 UNION ALL
    SELECT 29 UNION ALL SELECT 30 UNION ALL SELECT 31 UNION ALL SELECT 32 UNION ALL
    SELECT 33 UNION ALL SELECT 34 UNION ALL SELECT 35 UNION ALL SELECT 36 UNION ALL
    SELECT 37 UNION ALL SELECT 38 UNION ALL SELECT 39 UNION ALL SELECT 40 UNION ALL
    SELECT 41 UNION ALL SELECT 42 UNION ALL SELECT 43 UNION ALL SELECT 44 UNION ALL
    SELECT 45 UNION ALL SELECT 46 UNION ALL SELECT 47 UNION ALL SELECT 48 UNION ALL
    SELECT 49 UNION ALL SELECT 50
) AS numbers;
